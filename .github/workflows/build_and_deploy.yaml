name: Build and Deploy

on:
  push:
    branches:
      - master
      - csm-dev

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up commit SHA
        id: commit-sha
        run: echo "::set-output name=sha::${GITHUB_SHA}"

      - name: Set up branch name
        id: branch-name
        run: echo "::set-output name=branch::${GITHUB_REF##*/}"

      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: "1.23"

      - name: Build the Go application
        run: go build -o bin/app .

      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build Docker image
        run: docker build -t ghcr.io/${{ github.repository }}:latest .

      - name: Push Docker image to GitHub Container Registry
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            docker push ghcr.io/${{ github.repository }}:latest
          fi
          docker push ghcr.io/${{ github.repository }}:${{ steps.commit-sha.outputs.sha }}
          docker push ghcr.io/${{ github.repository }}:${{ steps.branch-name.outputs.branch }}

  update-argocd:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout homelab repo
        uses: actions/checkout@v2
        with:
          repository: ChristopherScot/homelab
          token: ${{ secrets.GITHUB_TOKEN }}
          path: homelab
    # - name: Update ArgoCD application
    #   run: |
    #     cd homelab
    #     run: sed -i 's|image: ghcr.io/.*/.*:.*|image: ghcr.io/${{ github.repository }}:latest|' app-of-apps/apps/${{ steps.repo-name.outputs.name }}.yaml        git config --global user.email "chris@christo"
    #     git config --global user.name "Your Name"
    #     git add path/to/argocd-application.yaml
    #     git commit -m "Update ArgoCD application to use new image"
    #     git push
